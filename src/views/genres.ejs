<!-- views/genres.ejs -->
<h1>Управление жанрами</h1>

<!-- Форма создания жанра -->
<div class="form-container">
  <form id="genreForm">
    <div class="form-group">
      <label for="name">Название жанра:</label>
      <input
        type="text"
        id="name"
        name="name"
        placeholder="Введите название жанра"
      />
      <div id="nameError" class="error"></div>
    </div>
    <button type="submit">Создать жанр</button>
  </form>
</div>

<!-- Список жанров -->
<div class="genre-list">
  <h2>Список жанров</h2>
  <ul id="genreList"></ul>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    // Загрузка списка жанров
    function loadGenres() {
      $.ajax({
        url: "/api/v1/genres",
        method: "GET",
        success: function (response) {
          const genreList = $("#genreList");
          genreList.empty();
          if (response.data && response.data.genres) {
            response.data.genres.forEach((genre) => {
              genreList.append(`<li>${genre.name}</li>`);
            });
          } else {
            genreList.append("<li>Жанры отсутствуют</li>");
          }
        },
        error: function (xhr) {
          alert(
            "Ошибка при загрузке жанров: " +
              (xhr.responseJSON?.message || xhr.statusText)
          );
        },
      });
    }

    // Загружаем жанры при загрузке страницы
    loadGenres();

    // Обработка отправки формы
    $("#genreForm").on("submit", function (e) {
      e.preventDefault();

      const name = $("#name").val().trim();
      const nameError = $("#nameError");

      // Сброс ошибки
      nameError.hide().text("");

      // Клиентская валидация
      if (!name) {
        nameError.text("Название жанра обязательно").show();
        return;
      }
      if (name.length < 2 || name.length > 50) {
        nameError.text("Название жанра должно быть от 2 до 50 символов").show();
        return;
      }
      if (!/^[a-zA-Zа-яА-Я\s-]+$/.test(name)) {
        nameError
          .text("Название жанра может содержать только буквы, пробелы и дефисы")
          .show();
        return;
      }

      // AJAX-запрос для создания жанра
      $.ajax({
        url: "/api/v1/genres",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ name }),
        success: function (response) {
          alert(response.message);
          $("#genreForm")[0].reset();
          loadGenres(); // Обновляем список жанров
        },
        error: function (xhr) {
          const response = xhr.responseJSON;
          if (response && response.errors) {
            response.errors.forEach((err) => {
              if (err.field === "name") {
                nameError.text(err.message).show();
              } else {
                alert(err.message);
              }
            });
          } else {
            alert("Ошибка: " + (xhr.responseJSON?.message || xhr.statusText));
          }
        },
      });
    });
  });
</script>

<style>
  .form-container {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
  .form-group {
    margin-bottom: 15px;
  }
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
  }
  .form-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
  }
  .form-group input:focus {
    outline: none;
    border-color: #007bff;
  }
  button {
    background-color: #007bff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover {
    background-color: #0056b3;
  }
  .error {
    color: #d32f2f;
    font-size: 14px;
    margin-top: 5px;
    display: none;
  }
  .genre-list {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .genre-list ul {
    list-style: none;
    padding: 0;
  }
  .genre-list li {
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-size: 16px;
  }
  .genre-list li:last-child {
    border-bottom: none;
  }
</style>
